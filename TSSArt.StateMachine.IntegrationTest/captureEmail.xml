<scxml xmlns="http://www.w3.org/2005/07/scxml" version="1.0" datamodel="ecmascript" initial="captureEmail">
  <datamodel>
    <data id="profileUrl" />
    <data id="cookies" />
  </datamodel>

  <state id="captureEmail" initial="getCurrentEmail">
    <datamodel>
      <data id="currentEmail" />
      <data id="formData" />
    </datamodel>

    <state id="getCurrentEmail">
      <invoke srcexpr="profileUrl" type="http">
        <param name="cookies" expr="cookies" />
        <param name="capture" expr="({
               'email': { 'xpath': './/input[@name=\'email\']', 'attr': 'value' },
               'form': { 'attr': ['name', '::value'], 'xpath': './/form[@id=\'your-profile\']//*[@name]'}})" />
        <finalize>
          <assign location="cookies" expr="_event.data.cookies" />
          <assign location="formData" expr="[]" />
          <foreach array="_event.data.content.form" item="item" index="i">
            <assign location="formData[i]" expr="({'name': item.name, 'value': item['::value']})" />
          </foreach>
        </finalize>
      </invoke>

      <transition event="done.invoke" cond="_event.data.content.email.length > 0" target="validateEmail">
        <assign location="currentEmail" expr="_event.data.content.email[0].value" />
      </transition>
      <transition event="done.invoke" target="failure" />
    </state>

    <state id="validateEmail">
      <invoke type="scxml" src="validateEmail">
        <param name="email" expr="currentEmail" />
      </invoke>

      <transition event="done.invoke" cond="_event.data.status == 'captureRequired'" target="replaceEmailRequest" />
      <transition event="done.invoke" target="ok" />
    </state>

    <state id="replaceEmailRequest">
      <transition target="ok" />
    </state>
  
    <transition event="error" target="error" />
  </state>

  <final id="ok">
    <donedata>
      <param name="status" expr="'ok'" />
      <param name="data" expr="_event.data" />
    </donedata>
  </final>

  <final id="failure">
    <donedata>
      <param name="status" expr="'failure'" />
      <param name="data" expr="_event.data" />
    </donedata>
  </final>

  <final id="error">
    <donedata>
      <param name="status" expr="'error'" />
      <param name="error" expr="_event.data" />
    </donedata>
  </final>
</scxml>