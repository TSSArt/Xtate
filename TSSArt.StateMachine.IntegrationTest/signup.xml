<scxml xmlns="http://www.w3.org/2005/07/scxml"
       xmlns:mid="http://tssart.com/scxml/customaction/mid"
       xmlns:basic="http://tssart.com/scxml/customaction/basic"
       xmlns:mime="http://tssart.com/scxml/customaction/mime"
       version="1.0" datamodel="ecmascript" initial="signup">
  <datamodel>
    <data id="loginUrl" />
    <data id="cookies" />
  </datamodel>

  <state id="signup" initial="createEmail">
    <datamodel>
      <data id="registerUrl" />
      <data id="resetPasswordUrl" />
      <data id="sitekey" />
      <data id="recaptchaResponse" expr="''" />
      <data id="username" />
      <data id="password" />
      <data id="email" />
      <data id="mailKey" />
      <data id="resetPasswordKey" />
    </datamodel>

    <onentry>
      <assign location="registerUrl" expr="loginUrl + '?action=register'" />
      <assign location="resetPasswordUrl" expr="loginUrl + '?action=resetpass'" />
    </onentry>

    <state id="createEmail">
      <invoke srcexpr="_x.configuration.mailEndpoint" type="http">
        <param name="method" expr="'post'" />
        <param name="accept" expr="'application/json'" />
        <finalize>
          <assign location="email" expr="_event.data.content.Email" />
          <assign location="mailKey" expr="_event.data.content.MailKey" />
        </finalize>
      </invoke>

      <transition event="done.invoke" target="loadRegisterPage" />
    </state>

    <state id="loadRegisterPage">
      <invoke srcexpr="registerUrl" type="http">
        <param name="cookies" expr="cookies" />
        <param name="capture"
               expr="({'sitekey': { 
                 'xpath': './/script[@type=\'text/javascript\']',   
                 'regex': '[\\\'\\\&quot;]sitekey[\\\'\\\&quot;]\\s*:\\s*[\\\'\\\&quot;](?&lt;value&gt;[^\\\'\\\&quot;]+)' 
               }})" />
        <finalize>
          <assign location="cookies" expr="_event.data.cookies" />
        </finalize>
      </invoke>

      <transition event="done.invoke" cond="!!_event.data.content.sitekey" target="registerCaptcha">
        <assign location="sitekey" expr="_event.data.content.sitekey.value" />
      </transition>
      <transition event="done.invoke" target="registerAccount" />
    </state>

    <state id="registerCaptcha">
      <invoke type="scxml" src="recaptcha">
        <param name="url" expr="registerUrl" />
        <param name="sitekey" expr="sitekey" />
      </invoke>

      <transition event="done.invoke" cond="_event.data.status == 'ok'" target="registerAccount">
        <assign location="recaptchaResponse" expr="_event.data.response" />
      </transition>
      <transition event="done.invoke" target="cancel" />
    </state>

    <state id="registerAccount">
      <onentry>
        <mid:storage location="username" operation="create" template="userid" rule="[a-z0-9]{1,20}" />
      </onentry>

      <invoke srcexpr="registerUrl" type="http">
        <param name="method" expr="'post'" />
        <param name="autoRedirect" expr="false" />
        <param name="contentType" expr="'application/x-www-form-urlencoded'" />
        <param name="cookies" expr="cookies" />
        <content
          expr="[
                   { name: 'user_login', value: username }, 
                   { name: 'user_email', value: email }, 
                   { name: 'g-recaptcha-response', value: recaptchaResponse }, 
                   { name: 'redirect_to', value: '' }, 
                   { name: 'wp-submit', value: 'Register' }
                ]" />
        <finalize>
          <assign location="cookies" expr="_event.data.cookies" />
        </finalize>
      </invoke>

      <transition event="done.invoke" target="waitForEmail" cond="_event.data.statusCode == 302" />
      <transition event="done.invoke" target="loadRegisterPage" />
    </state>

    <state id="waitForEmail">
      <datamodel>
        <data id="emailContent" />
        <data id="setPasswordUrl" />
      </datamodel>

      <invoke srcexpr="_x.configuration.mailEndpoint + '?lastReceivedOnUtc=2019-01-01&amp;email=' + email" type="http">
        <param name="accept" expr="'application/json'" />
        <finalize>
          <assign location="emailContent" expr="_event.data.content.EmailEntries[0].ContentRaw" />
          <basic:base64decode source="emailContent" destination="emailContent" />
          <mime:parseEmail source="emailContent" destination="setPasswordUrl"
                           regex="https?\:\/\/[A-Za-z0-9-._@\/]+\?[A-Za-z0-9-._~:?#[\]@!$&amp;&#039;()*+,;=\/]+" />
          <basic:parseUrl source="setPasswordUrl" destination="resetPasswordKey" parameter="key" />
        </finalize>
      </invoke>

      <transition event="done.invoke" target="loadResetPasswordPage" />
    </state>

    <state id="loadResetPasswordPage">
      <invoke srcexpr="resetPasswordUrl" type="http">
        <param name="cookies" expr="cookies" />
        <param name="capture"
               expr="({'sitekey': { 
                 'xpath': './/script[@type=\'text/javascript\']', 
                 'regex': '[\\\'\\\&quot;]sitekey[\\\'\\\&quot;]\\s*:\\s*[\\\'\\\&quot;](?&lt;value&gt;[^\\\'\\\&quot;]+)' 
               }})" />
        <finalize>
          <assign location="cookies" expr="_event.data.cookies" />
        </finalize>
      </invoke>

      <transition event="done.invoke" cond="!!_event.data.content.sitekey" target="resetPasswordCaptcha">
        <assign location="sitekey" expr="_event.data.content.sitekey.value" />
      </transition>
      <transition event="done.invoke" target="resetPassword" />
    </state>

    <state id="resetPasswordCaptcha">
      <invoke type="scxml" src="recaptcha">
        <param name="url" expr="resetPasswordUrl" />
        <param name="sitekey" expr="sitekey" />
      </invoke>

      <transition event="done.invoke" cond="_event.data.status == 'ok'" target="resetPassword">
        <assign location="recaptchaResponse" expr="_event.data.response" />
      </transition>
      <transition event="done.invoke" target="cancel" />
    </state>

    <state id="resetPassword">
      <onentry>
        <mid:storage location="password" operation="create" template="password" rule="[a-zA-Z0-9]{16}" />
      </onentry>

      <invoke srcexpr="resetPasswordUrl" type="http">
        <param name="method" expr="'post'" />
        <param name="autoRedirect" expr="false" />
        <param name="contentType" expr="'application/x-www-form-urlencoded'" />
        <param name="cookies" expr="cookies" />
        <content
          expr="[
                  { name: 'pass1', value: password }, 
                  { name: 'pass2', value: password }, 
                  { name: 'pw_weak', value: 'on' }, 
                  { name: 'g-recaptcha-response', value: recaptchaResponse }, 
                  { name: 'rp_key', value: resetPasswordKey }, 
                  { name: 'wp-submit', value: 'Reset Password' }
                ]" />
      </invoke>

      <transition event="done.invoke" target="ok" cond="_event.data.statusCode == 302" />
      <transition event="done.invoke" target="loadResetPasswordPage" />
    </state>

    <transition event="error" target="error" />
  </state>

  <final id="ok">
    <donedata>
      <param name="status" expr="'ok'" />
      <param name="data" expr="({ 'username': username, 'password': password, 'email': email, 'mailKey': mailKey })" />
    </donedata>
  </final>

  <final id="cancel">
    <donedata>
      <param name="status" expr="'cancel'" />
    </donedata>
  </final>

  <final id="error">
    <donedata>
      <param name="status" expr="'error'" />
      <param name="error" expr="_event.data" />
    </donedata>
  </final>
</scxml>