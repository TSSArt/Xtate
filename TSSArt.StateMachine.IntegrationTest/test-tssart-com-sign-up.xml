<scxml xmlns="http://www.w3.org/2005/07/scxml" version="1.0" datamodel="ecmascript" initial="RegisterEmail">
  <datamodel>
    <data id="email" />
    <data id="g_recaptcha_response" />
  </datamodel>
  <state id='RegisterEmail'>
    <onentry>
      <log label="RegisterEmail ENTERED" />
    </onentry>
    <invoke src='http://mid.dev.tssart.com/MailServer/Web2/api/Mail' type='http'>
      <param name='method' expr="'post'" />
      <param name='accept' expr="'application/json'" />
      <finalize>
        <assign location='email' expr='_event.data.content.Email' />
        <log label="Email CREATED:" expr="email" />
      </finalize>
    </invoke>
    <transition event='done.invoke' target='RegisterCaptcha' />
    <transition event='error' target='finErr' />
  </state>
  <state id="RegisterCaptcha">
    <datamodel>
      <data id="content" />
    </datamodel>
    <onentry>
      <assign location="content">
        <html xmlns="">
          <head>
            <script src="https://www.google.com/recaptcha/api.js" async=" defer="></script>
            <script type="text/javascript">
              function ok(){document.getElementById("frm").submit();}
            </script>
          </head>
          <body>
            <form id="frm" action="" method="POST">
              <div class="g-recaptcha" data-sitekey="6Lcr4RYTAAAAAN_gTioJ2RIkdiHu6IfDq870-2bO" data-callback="ok"></div>
            </form>
          </body>
        </html>
      </assign>
      <send type="http" target="http://localhost:5000/captcha" event="show">
        <param name="url" expr="'https://test.tssart.com/wp-login.php?action=register'" />
        <param name="content" expr="content" />
      </send>
    </onentry>
    <transition event='captcha.submitted' target='RegisterCaptcha'>
      <assign location='g_recaptcha_response' expr="_event.data.form['g-recaptcha-response']" />
      <log label="g_recaptcha_response" expr='g_recaptcha_response' />
    </transition>
  </state>
  <state id='RegisterAccount'>
    <onentry>
      <log label="RegisterAccount ENTERED" />
    </onentry>
    <invoke src='https://test.tssart.com/wp-login.php?action=register' type='http'>
      <param name='method' expr="'post'" />
      <param name='accept' expr="'application/x-www-form-urlencoded'" />
      <finalize>
        <assign location='email' expr='_event.data.content.Email' />
        <log label="Email CREATED:" expr="email" />
      </finalize>
    </invoke>
    <transition event='done.invoke' target='ConfirmEmail' />
    <transition event='error' target='finErr' />
  </state>
  <state id='ConfirmEmail'>
    <onentry>
      <log label="ConfirmEmail ENTERED" />
    </onentry>

    <invoke src='https://test.tssart.com/wp-login.php?action=register' type='http'>
      <param name='method' expr="'post'" />
      <!-- user_login=tadex4&user_email=xtadexsdfsfdsdf4565456%40gmail.com&g-recaptcha-response=03AOLTBLRqNT20wr0InQo56Kp9Q-Sqx1d-reVVx0eD3YN&redirect_to=&wp-submit=Register-->
      <finalize>
        <log label="Email REGISTERED" />
      </finalize>
    </invoke>

    <transition event='error' target='finErr' />
  </state>
  <!-- <datamodel>https://test.tssart.com/wp-login.php?action=register
    <data id="email" />
  </datamodel>
  <state id='RegisterEmail'>
    <invoke src='http://mid.dev.tssart.com/MailServer/Web2/api/Mail' type='http'>
      <param name='method' expr="'post'"/>
      <param name='accept' expr="'application/json'"/>
      <finalize>
        <assign location='email' expr='_event.data.content.Email' />
      </finalize>
    </invoke>
    <transition event='done.invoke' target='SendEmail'/>
    <transition event='error' target='finErr' />
  </state>
  <state id='SendEmail'>
    <invoke type='smtp'>
      <param name='server' expr="'hare.tssart.com'"/>
      <param name='from' expr="'ser@tssart.com'"/>
      <param name='to' expr='email'/>
      <param name='subject' expr="'This is Subject'"/>
      <param name='body' expr="'This is BODY'"/>
    </invoke>
    <transition event='done.invoke' target='ReCaptcha'/>
    <transition event='error' target='finErr'/>
  </state>
  <state id='ReCaptcha'>
    <invoke src='https://www.tssart.com/wp-login.php' type='browser'>
      <param name='type' expr='GoogleRecaptchaV2'/>
      <param name='sitekey' expr='6LdI3RYTAAAAAMkmqOQSdno04oej6pDHGFpU3TRG'/>
    </invoke>
    <transition event='done.invoke' target='WaitForEmail'/>
    <transition event='error' target='finErr'/>
  </state>
  <state id='WaitForEmail'>
    <invoke srcexpr='&quot;http://mid.dev.tssart.com/MailServer/Web2/api/Mail?lastReceivedOnUtc=2019-01-01&amp;email=&quot; + email' type='http'>
      <param name='accept' expr="'application/json'"/>
      <finalize xmlns:basic='http://tssart.com/scxml/customaction/basic' xmlns:mime='http://tssart.com/scxml/customaction/mime'>
        <assign location='emailContent' expr='_event.data.content.EmailEntries[0].ContentRaw' />
        <basic:base64decode source='emailContent' destination='emailContent'/>
        <mime:parseEmail source='emailContent' destination='confirmationUrl' xpath='' attr='' regex=''/>
		  </finalize>
    </invoke>
    <transition event='done.invoke' target='fin'/>
    <transition event='error' target='finErr' />
  </state>
   -->
  <final id='fin'>
    <donedata>
      <content expr='_event.data' />
    </donedata>
  </final>
  <final id='finErr'>
    <donedata>
      <content expr='_event.data' />
    </donedata>
  </final>

</scxml>