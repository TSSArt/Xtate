<scxml xmlns="http://www.w3.org/2005/07/scxml" version="1.0" datamodel="ecmascript" initial="login">
  <datamodel>
    <data id="loginUrl" />
    <data id="username" />
    <data id="password" />
    <data id="cookies" />
  </datamodel>
 
  <state id="login" initial="loadPage">
    <datamodel>
      <data id="sitekey" />
      <data id="recaptchaResponse" expr="''" />
    </datamodel>

    <state id="loadPage">
      <invoke srcexpr="loginUrl" type="http">
        <param name="cookies" expr="cookies" />
        <param name="capture" 
               expr="({'sitekey': { 
                 'xpath': './/script[@type=\'text/javascript\']', 
                 'regex': '[\\\'\\\&quot;]sitekey[\\\'\\\&quot;]\\s*:\\s*[\\\'\\\&quot;](?&lt;value&gt;[^\\\'\\\&quot;]+)' 
               }})" />
        <finalize>
          <assign location="cookies" expr="_event.data.cookies" />
        </finalize>
      </invoke>

      <transition event="done.invoke" cond="!!_event.data.content.sitekey" target="captcha">
        <assign location="sitekey" expr="_event.data.content.sitekey.value" />
      </transition>
      <transition event="done.invoke" target="loginRequest" />
    </state>

    <state id="captcha">
      <invoke type="scxml" src="recaptcha">
        <param name="url" expr="loginUrl" />
        <param name="sitekey" expr="sitekey" />
      </invoke>
      
      <transition event="done.invoke" cond="_event.data.status == 'ok'" target="loginRequest">
        <assign location="recaptchaResponse" expr="_event.data.response" />
      </transition>
      <transition event="done.invoke" target="cancel" />
    </state>

    <state id="loginRequest">
      <invoke srcexpr="loginUrl" type="http">
        <param name="method" expr="'post'" />
        <param name="autoRedirect" expr="false" />
        <param name="cookies" expr="cookies" />
        <param name="contentType" expr="'application/x-www-form-urlencoded'" />
        <content
          expr="[
                   { name: 'log', value: username }, 
                   { name: 'pwd', value: password }, 
                   { name: 'g-recaptcha-response', value: recaptchaResponse }, 
                   { name: 'redirect_to', value: '/wp-admin/' }, 
                   { name: 'wp-submit', value: 'Log In' },
                   { name: 'testcookie', value: '1' }
                ]" />
      </invoke>

      <transition event="done.invoke" cond="_event.data.statusCode == 302" target="ok" />
      <transition event="done.invoke" target="failure" />
    </state>

    <transition event="error" target="error" />
  </state>

  <final id="ok">
    <donedata>
      <param name="status" expr="'ok'" />
      <param name="data" expr="_event.data" />
    </donedata>
  </final>

  <final id="cancel">
    <donedata>
      <param name="status" expr="'cancel'" />
    </donedata>
  </final>

  <final id="failure">
    <donedata>
      <param name="status" expr="'failure'" />
      <param name="data" expr="_event.data" />
    </donedata>
  </final>

  <final id="error">
    <donedata>
      <param name="status" expr="'error'" />
      <param name="error" expr="_event.data" />
    </donedata>
  </final>
</scxml>