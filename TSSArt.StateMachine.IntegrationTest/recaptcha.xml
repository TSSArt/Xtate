<scxml xmlns="http://www.w3.org/2005/07/scxml" xmlns:basic="http://tssart.com/scxml/customaction/basic" version="1.0" datamodel="ecmascript" initial="recaptchaV2">
  <datamodel>
    <data id="url" />
    <data id="sitekey" />
    <data id="response" />
  </datamodel>

  <state id="recaptchaV2">
    <datamodel>
      <data id="args" expr="({})" />
      <data id="sendId" />
      <data id="captchaHtmlV2" />
      <data id="captchaHtmlV2template">
<html xmlns="">
  <head>
    <script src="https://www.google.com/recaptcha/api.js" async="" defer=""></script>
    <script type="text/javascript">
      function ok(){document.getElementById("frm").submit();}
    </script>
  </head>
  <body>
    <form id="frm" action="" method="POST">
      <div class="g-recaptcha" data-sitekey="{#sitekey#}" data-callback="ok"></div>
    </form>
  </body>
</html>
      </data>
    </datamodel>

    <onentry>
      <assign location="args.sitekey" expr="sitekey" />
      <basic:format template="captchaHtmlV2template" arguments="args" destination="captchaHtmlV2" />
      <send idlocation="sendId" type="http" targetexpr="_x.configuration.uiEndpoint" event="show">
        <param name="id" expr="sendId" />
        <param name="type" expr="'browser'" />
        <param name="event" expr="'done'" />
        <param name="source" expr="url" />
        <param name="content" expr="captchaHtmlV2" />
      </send>
      <send id="timeout" event="timeout" type="scxml" targetexpr="'#_scxml_' + _sessionid" delay="60s" />
    </onentry>

    <onexit>
      <send type="http" targetexpr="target" event="cancel">
        <param name="id" expr="sendId" />
      </send>
      <cancel sendid="timeout" />
    </onexit>

    <transition event="timeout" target="recaptchaV2" />

    <transition event="done" cond="_event.data.data.status == 'ok'" target="done">
      <assign location="response" expr="_event.data.data.parameters['g-recaptcha-response']" />
    </transition>

    <transition event="done" target="cancel" />

    <transition event="error" target="error" />
  </state>

  <final id="done">
    <donedata>
      <param name="status" expr="'ok'" />
      <param name="response" expr="response" />
    </donedata>
  </final>

  <final id="cancel">
    <donedata>
      <param name="status" expr="'cancel'" />
    </donedata>
  </final>

  <final id="error">
    <donedata>
      <param name="status" expr="'error'" />
      <param name="error" expr="_event.data" />
    </donedata>
  </final>
</scxml>
